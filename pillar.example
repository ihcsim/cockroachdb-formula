{% set ipv4_public = '127.0.0.1' -%}
{% if salt.network.ipaddrs(type='public') | length > 0 -%}
  {% set ipv4_public = salt.network.ipaddrs(type='public') | first -%}
{% endif -%}

{% set ipv4_private = '127.0.0.1' -%}
{% if salt.network.ipaddrs(type='private') | length > 0 -%}
  {% set ipv4_private = salt.network.ipaddrs(type='private') | first -%}
{% endif -%}
cockroachdb:
  initdb:
    user: maxroach
    database: maxroachdb

    sql:
      script: salt://cockroachdb/files/initdb.sql

      # Set 'keep' to true to keep the user-provided SQL script after the first start-up.
      # If this script shouldn't be re-executed on restart, set 'keep' to false to delete it from the minion's filesystem after the first start-up.
      keep: false

  runtime_options:
    - --insecure=true
    - --host={{ ipv4_private }}
    - --port=26300
    - --http-host={{ ipv4_public }}
    - --http-port=7070
    - --store=path=/etc/cockroachdb/data
    - --log-dir=/var/log/cockroachdb
